<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasam's Routing - Ergebnisse</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.25.0/maps/maps.css"
    />
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
        .marker-icon {
            background-position: center;
            background-size: 30px 30px;
            height: 30px;
            position: absolute;
            text-align: center;
            top: 3px;
            width: 30px;
        }
        .marker {
            height: 30px;
            width: 30px;
        }
    </style>
</head>
{% extends 'index.html' %}
{% block body %}
<body>
    <h1>Kasam's Routing - Ergebnisse</h1>

    <p><strong>Ihr Fahrzeug:</strong> {{ selected_vehicle.manufacturer + ' ' + selected_vehicle.model + ' ' + selected_vehicle.desc + ' Fuel Type:' + selected_vehicle.fuel_type}}</p>
    <p><strong>Startort:</strong> {{ start_location }} (Koordinaten: {{ start_coordinates }})</p>
    <p><strong>Zielort:</strong> {{ end_location }} (Koordinaten: {{ end_coordinates }})</p>

    {% if route_data.routes %}
        <h2>Routeninformationen Normal:</h2>
        <ul>
            {% for leg in route_data.routes[0].legs %}
                <li><strong>Entfernung:</strong> {{ leg.summary.lengthInMeters / 1000 }} km</li>
                <li><strong>Dauer:</strong> {{ leg.summary.travelTimeInSeconds / 60 }} Minuten</li>
            {% endfor %}
        </ul>
    {% else %}
        <p>Es konnte keine Route gefunden werden.</p>
    {% endif %}

    {% if eco_route_data.routes %}
        <h2>Routeninformationen Eco:</h2>
        <ul>
            {% for leg in eco_route_data.routes[0].legs %}
                <li><strong>Entfernung:</strong> {{ leg.summary.lengthInMeters / 1000 }} km</li>
                <li><strong>Dauer:</strong> {{ leg.summary.travelTimeInSeconds / 60 }} Minuten</li>
            {% endfor %}
        </ul>
    {% else %}
        <p>Es konnte keine Route gefunden werden.</p>
    {% endif %}

    <h2>Map:</h2> 
    <div id="map" class="map"></div>
    <button onclick="toggleLayer()">Routentyp Wechseln</button>

    <h2>Verkehrsflussinformation:</h2>
    {% if traffic_flow_data %}
        <p><strong>Verkehrsflussinformation:</strong> {{ traffic_flow_data.currentTravelTime }} Minuten, Geschwindigkeit: {{ traffic_flow_data.currentSpeed }} km/h</p>
    {% else %}
        <p>Keine Verkehrsflussinformation verf√ºgbar.</p>
    {% endif %}

    {% if geojson_data %}
        <script src="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.25.0/services/services-web.min.js"></script>
        <script src="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.25.0/maps/maps-web.min.js"></script>
        <script>
            var geoJson = {{ geojson_data|safe }};
            var ecoJson = {{ eco_geojson_data|safe }};
            var normalLayer;
            var ecoLayer;
            var isNormalLayerVisible = true;

            var map = tt.map({
                key: "1n7hfspttTjYk53H8xAeOcNM53cseplD",
                container: "map",
            });

            map.on('load', function () {
                map.addSource('route-source', {
                    type: 'geojson',
                    data: geoJson
                });
                map.addSource('eco-route-source', {
                    type: 'geojson',
                    data: ecoJson
                });

                map.addLayer({
                    id: 'route-layer',
                    type: 'line',
                    source: 'route-source',
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': '#007cbf',
                        'line-width': 4
                    }
                });

                var bounds = new tt.LngLatBounds();
                geoJson.features.forEach(function (feature) {
                    bounds.extend(feature.geometry.coordinates);
                });
                map.fitBounds(bounds, { padding: 20 });
            });

            function toggleLayer() {
                if (map.getLayer('route-layer')) {
                    map.removeLayer('route-layer')
                    map.addLayer({
                    id: 'eco-route-layer',
                    type: 'line',
                    source: 'eco-route-source',
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': '#176917',
                        'line-width': 4
                    }
                });
                }
                else {
                    map.removeLayer('eco-route-layer')
                    map.addLayer({
                    id: 'route-layer',
                    type: 'line',
                    source: 'route-source',
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': '#007cbf',
                        'line-width': 4
                    }
                });
                }
            }

            function createMarker(icon, position, popupText) {
                var markerElement = document.createElement('div');
                markerElement.className = 'marker';

                var markerContentElement = document.createElement('div');
                markerContentElement.className = 'marker-content';
                markerElement.appendChild(markerContentElement);

                var iconElement = document.createElement('div');
                iconElement.className = 'marker-icon';
                iconElement.style.backgroundImage =
                    'url(/static/' + icon + ')';
                if (icon == 'ziel_flagge.png'){
                    iconElement.style.left = '11px';
                }
                markerContentElement.appendChild(iconElement);

                var popup = new tt.Popup({offset: 30}).setText(popupText);

                new tt.Marker({element: markerElement, anchor: 'bottom'})
                    .setLngLat(position)
                    .setPopup(popup)
                    .addTo(map);
            }

            var firstCoordinate = geoJson.features[0].geometry.coordinates[0];
            var lastCoordinate = geoJson.features[0].geometry.coordinates[geoJson.features[0].geometry.coordinates.length - 1];
            
            createMarker('start_punkt.png', firstCoordinate, 'Startort');
            createMarker('ziel_flagge.png', lastCoordinate, 'Ziel');
        </script>
    {% else %}
        <p>Es konnte keine GeoJSON-Daten gefunden werden.</p>
    {% endif %}

</body>
{% endblock %}
